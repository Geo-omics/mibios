{% extends "mibios/base.html" %}
{% load render_table from django_tables2 %}

{% block curation_switch %}
{% if curation_switch_data %}
<li class="nav-item"><span class="navbar-text">Curation:</span></li>
<li class="nav-item"><div class="btn-group">
    {% if curation_switch_data.switch == 'off' %}
        <button type="button" class="btn btn-dark active disabled">on</button>
    {% endif %}
    <a class="btn btn-dark" role="button" href="{% url 'table' data_name=curation_switch_data.data_name %}{{ querystr }}">{{ curation_switch_data.switch }}</a>
    {% if curation_switch_data.switch == 'on' %}
        <button type="button" class="btn btn-dark active disabled">off</button>
    {% endif %}
</div></li>
{% endif %}
{% endblock %}

{% block content %}
{% if model %}
<h2>
    {{ data_name_verbose }} data
    {% if view.avg_by %}
    (averaged over {{ avg_by_short|join:" / " }}, {{ table.rows|length }} record groups)
    {% else %}
    ({{ table.rows|length }} records)
    {% endif %}
    {% if not view.curation %}[CURATION: OFF]{% endif %}
</h2>

{% if avg_by_data %}
    {% if view.avg_by %}
        {# at average view, display link back to normal table view #}
        [<a href="{% url 'table' data_name=url_data_name %}{{ querystr }}">normal table</a>]<br>
    {% else %}
        {# display links to average views #}
        average by:
        {% for slug, list in avg_by_data.items %}
        [<a href="{% url 'average' data_name=url_data_name avg_by=slug %}{{ querystr }}">{{ list|join:' / '}}</a>]<br>
        {% endfor %}
    {% endif %}
{% endif %}

{% if applied_filter or applied_excludes_list %}
    {% if view.negate %}(inversely){%endif%}
    applied filters (click to remove):
    {% if applied_filter %}
	with:
	{% for lookup, value, query_without in applied_filter %}
            {# we need a '?' here if removing the current filter results in an otherwise empty querystring, else the browser will see href="" and put in the current URL with current querystring, with '?' the browser links to the current URL with empty querystring (ezcpet for the '?') #}
            <a href="{{ query_without|default:'?' }}">{{ lookup }}={{ value }}</a>
	{% endfor %}
    {% endif %}
    {% for applied_exclude, query_without in applied_excludes_list %}
	without:
	<a href="{{ query_without }}">
	{% for lookup, value in applied_exclude.items %}
	    {{ lookup }}={{ value }}
	{% endfor %}
	</a>
    {% endfor %}
    <a href="{{ invquery }}">inverse filter</a>
    <br>
{% endif %}

{% for stats_type, stats_obj in sort_by_stats.items %}
    {# going through this loop only once usually #}
    {% if stats_type == 'choice_counts' %}
	{% if filter_link_data %}
	    {% if view.negate %}
		Sorted column
	    {% else %}
		Filter by
	    {% endif %}
	    {{ sort_by_field }}(count):
	    {% for value, count, query in filter_link_data %}
		{% if view.negate %}
		    {{ value|default:table.default }}({{ count }})
		{% else %}
                    <a href="{{ query }}">{{ value|default_if_none:table.default }}</a>({{ count }})
		{% endif %}
	    {% endfor %}
	    <br>
	{% endif %}
    {% elif stats_type == 'description' %}
	Column stats for {{ sort_by_field }}:
	{% for k, v in stats_obj.items %}
	    {% if k != 'count' %}
		{{ k }}: {{ v|floatformat }}{% if not forloop.last %},{% endif %}
	    {% endif %}
	{% endfor %}
	<br>
    {% elif stats_type == 'uniform' %}
	Sorted column: "{{ sort_by_field }}" has unique value:
	{% for val, count in stats_obj.items %}"{{ val|default:table.default }}"({{ count }}){% endfor %}
	<br>
    {% elif stats_type == 'unique' %}
        Sorted column "{{ sort_by_field }}": all values unique
    {% endif %}
{% endfor %}

{% if field_search_form %}
    <form action="{% url 'table' data_name=url_data_name %}{{ querystr }}" method="get">
        {% for i in field_search_form %}{{ i.label_tag }}{{ i}}{% endfor %}
        <input type="submit" value="Search">
    </form>
    <br>
{% endif %}

{% if view.avg_by %}
    [<a href="{% url 'average_export_form' data_name=url_data_name avg_by=avg_url_slug %}{{ querystr }}">export</a>]
{% else %}
    [<a href="{% url 'show_hide_form' data_name=url_data_name %}{{ querystr }}">show/hide columns</a>]
    [<a href="{% url 'import' data_name=data_name %}">import</a>]
    [<a href="{% url 'export_form' data_name=url_data_name %}{{ querystr }}">export</a>]
{% endif %}

{% if table_view_plugin_template %}{% include table_view_plugin_template %}{% endif %}
{% render_table table %}

{% endif %}
{% endblock %}
