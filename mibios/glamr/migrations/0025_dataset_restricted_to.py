# Generated by Django 3.2.19 on 2024-08-28 19:47
# data migration added manually

from django.db import migrations, models

from mibios.glamr.accounts import STAFF_PERMISSIONS, STAFF_GROUP_NAME


def fwd(app, schema_editor):
    """ Require the staff group to access private datasets """
    Dataset = app.get_model('glamr.Dataset')
    Group = app.get_model('auth.Group')
    Permission = app.get_model('auth.Permission')

    grp, _ = Group.objects.get_or_create(name=STAFF_GROUP_NAME)
    perms = Permission.objects.filter(codename__in=STAFF_PERMISSIONS)
    grp.permissions.set(perms)
    for i in Dataset.objects.filter(private=True):
        i.restricted_to.add(grp)


def rev(app, schema_editor):
    """ Make dataset with any restrictions private """
    Dataset = app.get_model('glamr.Dataset')
    Dataset.objects.exclude(restricted_to=None).update(private=True)


class Migration(migrations.Migration):

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
        ('glamr', '0024_delete_fakeuser'),
    ]

    operations = [
        migrations.AddField(
            model_name='dataset',
            name='restricted_to',
            field=models.ManyToManyField(to='auth.Group'),
        ),
        migrations.RunPython(fwd, rev)
    ]
